<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Debate Arena ‚Äî Powered by PrysmAI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    },
                    colors: {
                        gpt: { DEFAULT: '#3B82F6', light: '#60A5FA', dark: '#1D4ED8' },
                        claude: { DEFAULT: '#06B6D4', light: '#22D3EE', dark: '#0891B2' },
                        arena: { bg: '#0A0A0F', card: '#111118', border: '#1E1E2E', accent: '#8B5CF6' },
                    }
                }
            }
        }
    </script>
    <style>
        body { background: #0A0A0F; }
        .glow-blue { box-shadow: 0 0 20px rgba(59, 130, 246, 0.15); }
        .glow-cyan { box-shadow: 0 0 20px rgba(6, 182, 212, 0.15); }
        .typing-cursor::after { content: '‚ñä'; animation: blink 0.8s infinite; color: currentColor; opacity: 0.7; }
        @keyframes blink { 0%, 100% { opacity: 0.7; } 50% { opacity: 0; } }
        @keyframes fadeUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .fade-up { animation: fadeUp 0.5s ease-out forwards; }
        @keyframes pulse-ring { 0% { transform: scale(0.8); opacity: 1; } 100% { transform: scale(2); opacity: 0; } }
        .pulse-ring { animation: pulse-ring 1.5s ease-out infinite; }
        .prose-debate { line-height: 1.75; }
        .prose-debate p { margin-bottom: 0.75em; }
        .scrollbar-thin::-webkit-scrollbar { width: 4px; }
        .scrollbar-thin::-webkit-scrollbar-track { background: transparent; }
        .scrollbar-thin::-webkit-scrollbar-thumb { background: #333; border-radius: 2px; }
    </style>
</head>
<body class="text-gray-100 min-h-screen font-sans">

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê HEADER ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <header class="border-b border-arena-border/50 backdrop-blur-xl bg-arena-bg/80 sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-6 h-14 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-gpt to-claude flex items-center justify-center">
                    <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                    </svg>
                </div>
                <span class="text-lg font-bold tracking-tight">AI Debate <span class="text-arena-accent">Arena</span></span>
            </div>
            <div class="flex items-center gap-2 text-xs text-gray-500 font-mono">
                <span class="w-1.5 h-1.5 rounded-full bg-emerald-500"></span>
                Powered by <a href="https://prysmai.manus.space" target="_blank" class="text-cyan-400 hover:text-cyan-300 ml-1">PrysmAI</a>
            </div>
        </div>
    </header>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MAIN CONTENT ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <main class="max-w-7xl mx-auto px-6 py-8">

        <!-- ‚îÄ‚îÄ START SCREEN ‚îÄ‚îÄ -->
        <div id="start-screen" class="fade-up">
            <div class="text-center max-w-2xl mx-auto pt-16 pb-12">
                <div class="inline-flex items-center gap-2 px-3 py-1 rounded-full text-xs font-mono border border-arena-accent/30 bg-arena-accent/10 text-arena-accent mb-6">
                    <span class="w-1.5 h-1.5 rounded-full bg-arena-accent"></span>
                    GPT-4o Mini vs Claude Sonnet 4
                </div>
                <h1 class="text-4xl sm:text-5xl font-extrabold tracking-tight mb-4">
                    Two AIs enter.<br>
                    <span class="bg-gradient-to-r from-gpt to-claude bg-clip-text text-transparent">One argument wins.</span>
                </h1>
                <p class="text-gray-400 text-lg mb-10 max-w-lg mx-auto">
                    Pick a topic. Watch GPT-4o Mini and Claude Sonnet 4 debate it live. 
                    Then see inside their responses with PrysmAI's explainability engine.
                </p>

                <!-- Topic Input -->
                <div class="max-w-lg mx-auto mb-8">
                    <div class="flex gap-2">
                        <input 
                            id="topic-input" 
                            type="text" 
                            placeholder="Enter a debate topic..."
                            class="flex-1 h-12 px-4 rounded-lg bg-arena-card border border-arena-border text-white placeholder-gray-500 focus:outline-none focus:border-arena-accent/50 focus:ring-1 focus:ring-arena-accent/20 text-sm"
                        >
                        <button 
                            id="start-btn"
                            onclick="startDebate()"
                            class="h-12 px-6 rounded-lg bg-gradient-to-r from-gpt to-claude text-white font-semibold text-sm hover:opacity-90 transition-opacity whitespace-nowrap"
                        >
                            Start Debate ‚Üí
                        </button>
                    </div>
                </div>

                <!-- Preset Topics -->
                <div class="flex flex-wrap justify-center gap-2">
                    {% for topic in preset_topics %}
                    <button 
                        onclick="selectTopic('{{ topic }}')"
                        class="px-3 py-1.5 rounded-full text-xs border border-arena-border text-gray-400 hover:text-white hover:border-gray-600 transition-colors"
                    >
                        {{ topic }}
                    </button>
                    {% endfor %}
                </div>
            </div>

            <!-- How It Works -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 max-w-3xl mx-auto mt-8 mb-16">
                <div class="p-5 rounded-xl border border-arena-border bg-arena-card/50 text-center">
                    <div class="text-2xl mb-2">üéØ</div>
                    <h3 class="font-semibold text-sm mb-1">Pick a Topic</h3>
                    <p class="text-xs text-gray-500">Choose any topic for the AI models to debate</p>
                </div>
                <div class="p-5 rounded-xl border border-arena-border bg-arena-card/50 text-center">
                    <div class="text-2xl mb-2">‚öîÔ∏è</div>
                    <h3 class="font-semibold text-sm mb-1">Watch the Debate</h3>
                    <p class="text-xs text-gray-500">3 rounds of arguments, rebuttals, and closing statements</p>
                </div>
                <div class="p-5 rounded-xl border border-arena-border bg-arena-card/50 text-center">
                    <div class="text-2xl mb-2">üîç</div>
                    <h3 class="font-semibold text-sm mb-1">See Inside</h3>
                    <p class="text-xs text-gray-500">PrysmAI reveals confidence, cost, and hallucination risks</p>
                </div>
            </div>
        </div>

        <!-- ‚îÄ‚îÄ DEBATE SCREEN ‚îÄ‚îÄ -->
        <div id="debate-screen" class="hidden">
            <!-- Topic Banner -->
            <div class="text-center mb-6">
                <div class="text-xs font-mono text-gray-500 mb-1">DEBATING</div>
                <h2 id="debate-topic" class="text-xl font-bold"></h2>
            </div>

            <!-- Round Indicator -->
            <div class="flex items-center justify-center gap-3 mb-6">
                <div id="round-1-dot" class="w-8 h-8 rounded-full border-2 border-arena-border flex items-center justify-center text-xs font-mono text-gray-500">1</div>
                <div class="w-8 h-0.5 bg-arena-border"></div>
                <div id="round-2-dot" class="w-8 h-8 rounded-full border-2 border-arena-border flex items-center justify-center text-xs font-mono text-gray-500">2</div>
                <div class="w-8 h-0.5 bg-arena-border"></div>
                <div id="round-3-dot" class="w-8 h-8 rounded-full border-2 border-arena-border flex items-center justify-center text-xs font-mono text-gray-500">3</div>
                <div class="w-8 h-0.5 bg-arena-border"></div>
                <div id="judge-dot" class="w-8 h-8 rounded-full border-2 border-arena-border flex items-center justify-center text-xs font-mono text-gray-500">‚öñ</div>
            </div>

            <!-- Debate Panels -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-6">
                <!-- GPT Panel -->
                <div class="rounded-xl border border-gpt/20 bg-arena-card overflow-hidden glow-blue">
                    <div class="px-4 py-3 border-b border-gpt/10 flex items-center justify-between">
                        <div class="flex items-center gap-2">
                            <div class="w-3 h-3 rounded-full bg-gpt"></div>
                            <span class="font-semibold text-sm text-gpt-light">GPT-4o Mini</span>
                            <span class="text-[10px] font-mono text-gray-600 border border-gray-700 px-1.5 py-0.5 rounded">OpenAI</span>
                        </div>
                        <div id="gpt-status" class="text-[10px] font-mono text-gray-600">WAITING</div>
                    </div>
                    <div id="gpt-content" class="p-4 min-h-[200px] max-h-[400px] overflow-y-auto scrollbar-thin prose-debate text-sm text-gray-300">
                        <span class="text-gray-600 italic">Waiting for debate to start...</span>
                    </div>
                    <div id="gpt-metrics" class="px-4 py-2 border-t border-gpt/10 hidden">
                        <div class="flex gap-4 text-[10px] font-mono text-gray-500">
                            <span>Latency: <span id="gpt-latency" class="text-gpt-light">‚Äî</span></span>
                            <span>TTFT: <span id="gpt-ttft" class="text-gpt-light">‚Äî</span></span>
                            <span>Tokens: <span id="gpt-tokens" class="text-gpt-light">‚Äî</span></span>
                        </div>
                    </div>
                </div>

                <!-- Claude Panel -->
                <div class="rounded-xl border border-claude/20 bg-arena-card overflow-hidden glow-cyan">
                    <div class="px-4 py-3 border-b border-claude/10 flex items-center justify-between">
                        <div class="flex items-center gap-2">
                            <div class="w-3 h-3 rounded-full bg-claude"></div>
                            <span class="font-semibold text-sm text-claude-light">Claude Sonnet 4</span>
                            <span class="text-[10px] font-mono text-gray-600 border border-gray-700 px-1.5 py-0.5 rounded">Anthropic</span>
                        </div>
                        <div id="claude-status" class="text-[10px] font-mono text-gray-600">WAITING</div>
                    </div>
                    <div id="claude-content" class="p-4 min-h-[200px] max-h-[400px] overflow-y-auto scrollbar-thin prose-debate text-sm text-gray-300">
                        <span class="text-gray-600 italic">Waiting for debate to start...</span>
                    </div>
                    <div id="claude-metrics" class="px-4 py-2 border-t border-claude/10 hidden">
                        <div class="flex gap-4 text-[10px] font-mono text-gray-500">
                            <span>Latency: <span id="claude-latency" class="text-claude-light">‚Äî</span></span>
                            <span>TTFT: <span id="claude-ttft" class="text-claude-light">‚Äî</span></span>
                            <span>Tokens: <span id="claude-tokens" class="text-claude-light">‚Äî</span></span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Round Controls -->
            <div class="flex justify-center gap-3 mb-6">
                <button 
                    id="next-round-btn"
                    onclick="nextRound()"
                    class="hidden h-10 px-6 rounded-lg bg-arena-accent text-white font-semibold text-sm hover:bg-arena-accent/80 transition-colors"
                >
                    Next Round ‚Üí
                </button>
                <button 
                    id="judge-btn"
                    onclick="getVerdict()"
                    class="hidden h-10 px-6 rounded-lg bg-gradient-to-r from-amber-500 to-orange-500 text-white font-semibold text-sm hover:opacity-90 transition-opacity"
                >
                    ‚öñÔ∏è Get Judge's Verdict
                </button>
            </div>

            <!-- Judge Verdict -->
            <div id="verdict-panel" class="hidden mb-6 fade-up">
                <div class="rounded-xl border border-amber-500/20 bg-arena-card overflow-hidden">
                    <div class="px-4 py-3 border-b border-amber-500/10 flex items-center gap-2">
                        <span class="text-lg">‚öñÔ∏è</span>
                        <span class="font-semibold text-sm text-amber-400">Judge's Verdict</span>
                        <span class="text-[10px] font-mono text-gray-600 border border-gray-700 px-1.5 py-0.5 rounded ml-auto">NON-STREAMING</span>
                    </div>
                    <div id="verdict-content" class="p-4 text-sm text-gray-300 prose-debate"></div>
                    <div id="verdict-metrics" class="px-4 py-2 border-t border-amber-500/10">
                        <div class="flex gap-4 text-[10px] font-mono text-gray-500">
                            <span>Latency: <span id="verdict-latency" class="text-amber-400">‚Äî</span></span>
                            <span>Tokens: <span id="verdict-tokens" class="text-amber-400">‚Äî</span></span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- PrysmAI Insights Panel -->
            <div id="insights-panel" class="hidden fade-up">
                <div class="rounded-xl border border-arena-accent/20 bg-arena-card overflow-hidden">
                    <div class="px-4 py-3 border-b border-arena-accent/10 flex items-center justify-between">
                        <div class="flex items-center gap-2">
                            <div class="w-6 h-6 rounded bg-arena-accent/20 flex items-center justify-center">
                                <svg class="w-3.5 h-3.5 text-arena-accent" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                                </svg>
                            </div>
                            <span class="font-semibold text-sm text-arena-accent">PrysmAI Insights</span>
                        </div>
                        <a href="https://prysmai.manus.space/dashboard" target="_blank" class="text-[10px] font-mono text-arena-accent hover:text-arena-accent/80">
                            View Full Dashboard ‚Üí
                        </a>
                    </div>
                    <div class="p-4">
                        <!-- Metrics Comparison -->
                        <div class="grid grid-cols-2 lg:grid-cols-4 gap-3 mb-4">
                            <div class="p-3 rounded-lg bg-arena-bg border border-arena-border">
                                <div class="text-[10px] font-mono text-gray-500 mb-1">TOTAL LATENCY</div>
                                <div class="flex items-end gap-2">
                                    <span class="text-lg font-bold text-gpt-light" id="insight-gpt-latency">‚Äî</span>
                                    <span class="text-xs text-gray-600">vs</span>
                                    <span class="text-lg font-bold text-claude-light" id="insight-claude-latency">‚Äî</span>
                                </div>
                            </div>
                            <div class="p-3 rounded-lg bg-arena-bg border border-arena-border">
                                <div class="text-[10px] font-mono text-gray-500 mb-1">AVG TTFT</div>
                                <div class="flex items-end gap-2">
                                    <span class="text-lg font-bold text-gpt-light" id="insight-gpt-ttft">‚Äî</span>
                                    <span class="text-xs text-gray-600">vs</span>
                                    <span class="text-lg font-bold text-claude-light" id="insight-claude-ttft">‚Äî</span>
                                </div>
                            </div>
                            <div class="p-3 rounded-lg bg-arena-bg border border-arena-border">
                                <div class="text-[10px] font-mono text-gray-500 mb-1">TOTAL TOKENS</div>
                                <div class="flex items-end gap-2">
                                    <span class="text-lg font-bold text-gpt-light" id="insight-gpt-tokens">‚Äî</span>
                                    <span class="text-xs text-gray-600">vs</span>
                                    <span class="text-lg font-bold text-claude-light" id="insight-claude-tokens">‚Äî</span>
                                </div>
                            </div>
                            <div class="p-3 rounded-lg bg-arena-bg border border-arena-border">
                                <div class="text-[10px] font-mono text-gray-500 mb-1">API CALLS</div>
                                <div class="text-lg font-bold text-arena-accent" id="insight-total-calls">‚Äî</div>
                                <div class="text-[10px] text-gray-600">All traced by PrysmAI</div>
                            </div>
                        </div>

                        <!-- Feature Highlights -->
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                            <div class="p-3 rounded-lg bg-arena-bg border border-arena-border">
                                <div class="flex items-center gap-2 mb-2">
                                    <span class="text-sm">üéØ</span>
                                    <span class="text-xs font-semibold text-gray-300">Multi-Provider Routing</span>
                                </div>
                                <p class="text-[11px] text-gray-500">One <code class="text-arena-accent">sk-prysm-*</code> key routed to both OpenAI and Anthropic based on model name. Zero config.</p>
                            </div>
                            <div class="p-3 rounded-lg bg-arena-bg border border-arena-border">
                                <div class="flex items-center gap-2 mb-2">
                                    <span class="text-sm">üìä</span>
                                    <span class="text-xs font-semibold text-gray-300">Full Observability</span>
                                </div>
                                <p class="text-[11px] text-gray-500">Every request logged with latency, tokens, cost, and full prompt/completion. View traces in the PrysmAI dashboard.</p>
                            </div>
                            <div class="p-3 rounded-lg bg-arena-bg border border-arena-border">
                                <div class="flex items-center gap-2 mb-2">
                                    <span class="text-sm">üî¨</span>
                                    <span class="text-xs font-semibold text-gray-300">Explainability</span>
                                </div>
                                <p class="text-[11px] text-gray-500">Confidence heatmaps, hallucination detection, and "Why did it say that?" ‚Äî see inside every response.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- New Debate Button -->
            <div id="new-debate-btn" class="hidden text-center mt-6 mb-12">
                <button 
                    onclick="resetDebate()"
                    class="h-10 px-6 rounded-lg border border-arena-border text-gray-400 hover:text-white hover:border-gray-600 text-sm transition-colors"
                >
                    ‚Üê Start New Debate
                </button>
            </div>
        </div>
    </main>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê FOOTER ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <footer class="border-t border-arena-border/30 mt-16">
        <div class="max-w-7xl mx-auto px-6 py-6 flex items-center justify-between text-xs text-gray-600">
            <span>Built with <a href="https://prysmai.manus.space" target="_blank" class="text-cyan-500 hover:text-cyan-400">PrysmAI</a> ‚Äî AI Observability for builders who go deeper</span>
            <span class="font-mono">v1.0.0</span>
        </div>
    </footer>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê JAVASCRIPT ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <script>
        // ‚îÄ‚îÄ State ‚îÄ‚îÄ
        let sessionId = null;
        let currentRound = 0;
        const totalRounds = 3;
        const metrics = {
            gpt: { totalLatency: 0, totalTtft: 0, totalTokens: 0, rounds: 0 },
            claude: { totalLatency: 0, totalTtft: 0, totalTokens: 0, rounds: 0 },
        };

        // ‚îÄ‚îÄ Topic Selection ‚îÄ‚îÄ
        function selectTopic(topic) {
            document.getElementById('topic-input').value = topic;
        }

        // ‚îÄ‚îÄ Start Debate ‚îÄ‚îÄ
        async function startDebate() {
            const topic = document.getElementById('topic-input').value.trim();
            if (!topic) return;

            const btn = document.getElementById('start-btn');
            btn.textContent = 'Starting...';
            btn.disabled = true;

            try {
                const res = await fetch('/api/debate/start', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ topic }),
                });
                const data = await res.json();
                
                if (data.error) {
                    alert(data.error);
                    return;
                }

                sessionId = data.session_id;
                document.getElementById('debate-topic').textContent = `"${topic}"`;
                
                // Switch screens
                document.getElementById('start-screen').classList.add('hidden');
                document.getElementById('debate-screen').classList.remove('hidden');
                document.getElementById('debate-screen').classList.add('fade-up');

                // Start round 1
                currentRound = 1;
                runRound(1);
            } catch (err) {
                alert('Failed to start debate: ' + err.message);
            } finally {
                btn.textContent = 'Start Debate ‚Üí';
                btn.disabled = false;
            }
        }

        // ‚îÄ‚îÄ Run a Debate Round ‚îÄ‚îÄ
        function runRound(roundNum) {
            // Update round dots
            const dot = document.getElementById(`round-${roundNum}-dot`);
            dot.classList.remove('border-arena-border', 'text-gray-500');
            dot.classList.add('border-arena-accent', 'text-arena-accent', 'bg-arena-accent/10');
            
            // Add pulsing ring
            dot.innerHTML = `<span class="absolute w-8 h-8 rounded-full border border-arena-accent/50 pulse-ring"></span>${roundNum}`;
            dot.classList.add('relative');

            // Reset content for this round
            const roundLabel = roundNum === 1 ? 'Opening Argument' : roundNum === 2 ? 'Rebuttal' : 'Closing Statement';
            
            document.getElementById('gpt-content').innerHTML = `<div class="text-[10px] font-mono text-gpt/50 mb-2">ROUND ${roundNum} ‚Äî ${roundLabel}</div>`;
            document.getElementById('claude-content').innerHTML = `<div class="text-[10px] font-mono text-claude/50 mb-2">ROUND ${roundNum} ‚Äî ${roundLabel}</div>`;
            document.getElementById('gpt-status').textContent = 'WAITING';
            document.getElementById('claude-status').textContent = 'WAITING';

            // Hide controls during round
            document.getElementById('next-round-btn').classList.add('hidden');
            document.getElementById('judge-btn').classList.add('hidden');

            const evtSource = new EventSource(`/api/debate/${sessionId}/round/${roundNum}`);
            let currentModel = null;

            evtSource.addEventListener('round_start', (e) => {
                // Round started
            });

            evtSource.addEventListener('model_start', (e) => {
                const data = JSON.parse(e.data);
                currentModel = data.model;
                document.getElementById(`${data.model}-status`).textContent = 'STREAMING';
                document.getElementById(`${data.model}-status`).classList.add('text-emerald-400');
                
                // Add typing cursor
                const contentEl = document.getElementById(`${data.model}-content`);
                contentEl.innerHTML += '<span class="typing-cursor"></span>';
            });

            evtSource.addEventListener('token', (e) => {
                const data = JSON.parse(e.data);
                const contentEl = document.getElementById(`${data.model}-content`);
                
                // Remove cursor, add token, re-add cursor
                const cursor = contentEl.querySelector('.typing-cursor');
                if (cursor) cursor.remove();
                
                contentEl.innerHTML += escapeHtml(data.content);
                contentEl.innerHTML += '<span class="typing-cursor"></span>';
                
                // Auto-scroll
                contentEl.scrollTop = contentEl.scrollHeight;
            });

            evtSource.addEventListener('done', (e) => {
                const data = JSON.parse(e.data);
                const contentEl = document.getElementById(`${data.model}-content`);
                
                // Remove cursor
                const cursor = contentEl.querySelector('.typing-cursor');
                if (cursor) cursor.remove();

                // Update status
                document.getElementById(`${data.model}-status`).textContent = 'DONE';
                document.getElementById(`${data.model}-status`).classList.remove('text-emerald-400');
                document.getElementById(`${data.model}-status`).classList.add('text-gray-500');

                // Show metrics
                document.getElementById(`${data.model}-metrics`).classList.remove('hidden');
                document.getElementById(`${data.model}-latency`).textContent = `${(data.latency_ms / 1000).toFixed(1)}s`;
                document.getElementById(`${data.model}-ttft`).textContent = `${Math.round(data.ttft_ms)}ms`;
                document.getElementById(`${data.model}-tokens`).textContent = data.tokens || '‚Äî';

                // Accumulate metrics
                metrics[data.model].totalLatency += data.latency_ms;
                metrics[data.model].totalTtft += data.ttft_ms;
                metrics[data.model].totalTokens += (data.tokens || 0);
                metrics[data.model].rounds += 1;
            });

            evtSource.addEventListener('error', (e) => {
                // Check if it's a real error or just SSE closing
                if (evtSource.readyState === EventSource.CLOSED) return;
                try {
                    const data = JSON.parse(e.data);
                    const contentEl = document.getElementById(`${data.model}-content`);
                    contentEl.innerHTML += `<div class="text-red-400 mt-2 text-xs">Error: ${escapeHtml(data.error)}</div>`;
                } catch {}
            });

            evtSource.addEventListener('round_end', (e) => {
                evtSource.close();
                
                // Update round dot ‚Äî completed
                dot.innerHTML = `${roundNum}`;
                dot.classList.remove('border-arena-accent', 'text-arena-accent', 'bg-arena-accent/10');
                dot.classList.add('border-emerald-500', 'text-emerald-400', 'bg-emerald-500/10');

                currentRound = roundNum;

                // Show appropriate button
                if (roundNum < totalRounds) {
                    document.getElementById('next-round-btn').classList.remove('hidden');
                } else {
                    document.getElementById('judge-btn').classList.remove('hidden');
                }
            });

            evtSource.onerror = () => {
                if (evtSource.readyState === EventSource.CLOSED) return;
                evtSource.close();
            };
        }

        // ‚îÄ‚îÄ Next Round ‚îÄ‚îÄ
        function nextRound() {
            currentRound++;
            runRound(currentRound);
        }

        // ‚îÄ‚îÄ Get Verdict ‚îÄ‚îÄ
        async function getVerdict() {
            const btn = document.getElementById('judge-btn');
            btn.textContent = '‚öñÔ∏è Judging...';
            btn.disabled = true;

            // Update judge dot
            const judgeDot = document.getElementById('judge-dot');
            judgeDot.classList.remove('border-arena-border', 'text-gray-500');
            judgeDot.classList.add('border-amber-500', 'text-amber-400', 'bg-amber-500/10');

            try {
                const res = await fetch(`/api/debate/${sessionId}/judge`, { method: 'POST' });
                const data = await res.json();

                // Show verdict
                document.getElementById('verdict-panel').classList.remove('hidden');
                document.getElementById('verdict-content').textContent = data.content;
                document.getElementById('verdict-latency').textContent = `${(data.latency_ms / 1000).toFixed(1)}s`;
                document.getElementById('verdict-tokens').textContent = data.tokens || '‚Äî';

                // Update judge dot ‚Äî completed
                judgeDot.classList.remove('border-amber-500', 'text-amber-400', 'bg-amber-500/10');
                judgeDot.classList.add('border-emerald-500', 'text-emerald-400', 'bg-emerald-500/10');

                // Show insights panel
                updateInsights();
                document.getElementById('insights-panel').classList.remove('hidden');
                
                // Show new debate button
                document.getElementById('new-debate-btn').classList.remove('hidden');
                
                // Hide judge button
                btn.classList.add('hidden');

            } catch (err) {
                alert('Failed to get verdict: ' + err.message);
            } finally {
                btn.textContent = '‚öñÔ∏è Get Judge\'s Verdict';
                btn.disabled = false;
            }
        }

        // ‚îÄ‚îÄ Update Insights ‚îÄ‚îÄ
        function updateInsights() {
            const gpt = metrics.gpt;
            const claude = metrics.claude;

            document.getElementById('insight-gpt-latency').textContent = `${(gpt.totalLatency / 1000).toFixed(1)}s`;
            document.getElementById('insight-claude-latency').textContent = `${(claude.totalLatency / 1000).toFixed(1)}s`;
            
            document.getElementById('insight-gpt-ttft').textContent = gpt.rounds > 0 ? `${Math.round(gpt.totalTtft / gpt.rounds)}ms` : '‚Äî';
            document.getElementById('insight-claude-ttft').textContent = claude.rounds > 0 ? `${Math.round(claude.totalTtft / claude.rounds)}ms` : '‚Äî';
            
            document.getElementById('insight-gpt-tokens').textContent = gpt.totalTokens || '‚Äî';
            document.getElementById('insight-claude-tokens').textContent = claude.totalTokens || '‚Äî';
            
            // Total API calls = 3 rounds √ó 2 models + 1 judge = 7
            document.getElementById('insight-total-calls').textContent = `${(gpt.rounds + claude.rounds + 1)}`;
        }

        // ‚îÄ‚îÄ Reset ‚îÄ‚îÄ
        function resetDebate() {
            sessionId = null;
            currentRound = 0;
            metrics.gpt = { totalLatency: 0, totalTtft: 0, totalTokens: 0, rounds: 0 };
            metrics.claude = { totalLatency: 0, totalTtft: 0, totalTokens: 0, rounds: 0 };

            // Reset round dots
            for (let i = 1; i <= 3; i++) {
                const dot = document.getElementById(`round-${i}-dot`);
                dot.className = 'w-8 h-8 rounded-full border-2 border-arena-border flex items-center justify-center text-xs font-mono text-gray-500';
                dot.innerHTML = `${i}`;
            }
            const judgeDot = document.getElementById('judge-dot');
            judgeDot.className = 'w-8 h-8 rounded-full border-2 border-arena-border flex items-center justify-center text-xs font-mono text-gray-500';
            judgeDot.innerHTML = '‚öñ';

            // Hide panels
            document.getElementById('verdict-panel').classList.add('hidden');
            document.getElementById('insights-panel').classList.add('hidden');
            document.getElementById('new-debate-btn').classList.add('hidden');
            document.getElementById('next-round-btn').classList.add('hidden');
            document.getElementById('judge-btn').classList.add('hidden');

            // Reset content
            document.getElementById('gpt-content').innerHTML = '<span class="text-gray-600 italic">Waiting for debate to start...</span>';
            document.getElementById('claude-content').innerHTML = '<span class="text-gray-600 italic">Waiting for debate to start...</span>';
            document.getElementById('gpt-metrics').classList.add('hidden');
            document.getElementById('claude-metrics').classList.add('hidden');

            // Switch screens
            document.getElementById('debate-screen').classList.add('hidden');
            document.getElementById('start-screen').classList.remove('hidden');
            document.getElementById('topic-input').value = '';
        }

        // ‚îÄ‚îÄ Utility ‚îÄ‚îÄ
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ‚îÄ‚îÄ Enter key to start ‚îÄ‚îÄ
        document.getElementById('topic-input').addEventListener('keydown', (e) => {
            if (e.key === 'Enter') startDebate();
        });
    </script>
</body>
</html>
